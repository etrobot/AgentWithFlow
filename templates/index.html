<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Graph Control</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: false, theme: 'dark' });

        function renderMermaid() {
            mermaid.init(undefined, document.querySelectorAll(".mermaid"));
        }

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("control-form");
            const startButton = document.getElementById("start");
            const stopButton = document.getElementById("stop");
            const graphContainer = document.getElementById("graph-container");
            const initialCommandInput = document.getElementById("initial_command");
            const saveStatus = document.getElementById("save-status");

            let intervalId;

            async function startGraphUpdates() {
                intervalId = setInterval(async () => {
                    try {
                        const response = await fetch('/graph');
                        if (response.ok) {
                            const data = await response.json();
                            graphContainer.innerHTML = `<pre class="mermaid">${data.mermaid_chart}</pre>`;
                            renderMermaid();
                        } else {
                            alert('Network Error!');
                        }
                    } catch (error) {
                        alert('Network Error: ' + error.message);
                    }
                }, 1000);
            }
            startGraphUpdates();

            function checkInitialCommand() {
                if (initialCommandInput.value.trim().length < 20) {
                    startButton.disabled = true;
                    startButton.classList.add("opacity-50", "cursor-not-allowed");
                } else {
                    startButton.disabled = false;
                    startButton.classList.remove("opacity-50", "cursor-not-allowed");
                }
            }

            checkInitialCommand();

            initialCommandInput.addEventListener("input", checkInitialCommand);

            startButton.addEventListener("click", async () => {
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });

                try {
                    await fetch("/start", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(data)
                    });
                } catch (error) {
                    alert('Network Error: ' + error.message);
                }
            });

            stopButton.addEventListener("click", async () => {
                try {
                    await fetch("/stop", { method: "POST" });
                    clearInterval(intervalId);
                } catch (error) {
                    alert('Network Error: ' + error.message);
                }
            });

            const loadSettings = () => {
                const settings = JSON.parse(localStorage.getItem('graphControlSettings') || '{}');
                Object.keys(settings).forEach(key => {
                    const input = document.querySelector(`input[name=${key}]`);
                    if (input) {
                        input.value = settings[key];
                    }
                });
                checkInitialCommand();
            };

            loadSettings();

            const saveButton = document.getElementById("save");
            saveButton.addEventListener("click", () => {
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });

                localStorage.setItem('graphControlSettings', JSON.stringify(data));
                const now = new Date();
                saveStatus.textContent = `Saved at ${now.toLocaleString()}`;
                saveStatus.classList.remove("hidden");
                setTimeout(() => {
                    saveStatus.classList.add("hidden");
                }, 3000);
            });

            renderMermaid();
        });
    </script>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto flex justify-center items-center h-screen max-w-4xl">
        <div class="control-panel w-1/2 p-6 flex justify-center items-center">
            <div class="bg-gray-800 rounded-md shadow-lg p-6 w-full">
                <h1 class="text-2xl font-bold mb-6 text-center text-white">Graph Control</h1>
                <form id="control-form" class="space-y-4">
                    <div>
                        <label for="initial_command" class="block text-sm font-medium text-gray-300">Command:</label>
                        <input type="text" id="initial_command" name="initial_command" required class="mt-1 block w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                    </div>
                    <div>
                        <label for="task_id" class="block text-sm font-medium text-gray-300">Task ID (Optional):</label>
                        <input type="text" id="task_id" name="task_id" class="mt-1 block w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white">
                    </div>
                    <div class="flex justify-between gap-4">
                        <button type="button" id="start" class="w-1/3 bg-green-500 py-1 text-white rounded-md shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition-opacity duration-300">Start</button>
                        <button type="button" id="stop" class="w-1/3  bg-purple-500 py-1 text-white rounded-md shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">Stop</button>
                        <button type="button" id="save" class="w-1/3  bg-black py-1 text-white rounded-md shadow-md hover:bg-grey-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">Save Settings</button>
                    </div>
                </form>
                <div id="save-status" class="text-center text-green-500 mt-4 hidden"></div>
            </div>
        </div>
        <div id="graph-container" class="graph-container w-1/2 flex justify-center items-center">
        </div>
    </div>
</body>
</html>